@page
@model CBT_Practice.Pages.CBT.SevenColumns.Step02_AutoThoughtsModel
@{
    // タブ名の定義
    ViewData["Title"] = "７つのコラム 新規作成";

    /* その他の初期設定値 */
    // 感情欄の初期表示数
    var defaultLength = 3;
    // 自動思考のインデックス
    var autoThoughtIndex = 0;
}

<div class="main-title">
    <h1>７つのコラム　自動思考の内容</h1>
</div>


<div class="button-section">
    <a asp-page="index" class="btn-link">一覧に戻る</a>
</div>

<div class="main-contents">
    <div class="caption">
        <label class="main-caption">湧いてきた自動思考とその時の感情を整理しよう</label>
        <br>
        <label class="sub-caption">(メインで取り扱いたい自動思考にチェック)</label>
    </div>

    <div class="auto-thought-section" data-thought-index="@autoThoughtIndex">
        <div class="auto-thought-area">
            <input type="radio" name="mainThought" checked>
            <label class="title">自動思考@(autoThoughtIndex)</label>
            <div class="auto-thought">
                <input type="text" value="○○と思われたかも">
            </div>
        </div>
        <div class="emotion-section">
            <label>その時の感情</label>
            @for(int i = 0; i < defaultLength; i++)
            {
                <div class="emotion-area">
                    <input name="emotion@(i + 1)" type="text" class="emotion">
                    <input name="emotion-point@(i + 1)" type="text" class="emotion-point">
                </div>
            }
        </div>
        <div class="emotion-btn-area">
            <button class="emotion-add-btn">感情の追加</button>
            <button class="emotion-del-btn">感情の削除</button>
        </div>
    </div>

    <div class="added-section">
        <div class="auto-thought-section">
            <div class="auto-thought-area">
                <input type="radio" name="mainThought">
                <label class="title">自動思考@(autoThoughtIndex++)</label>
                <div class="auto-thought">
                    <input type="text" value="">
                </div>
            </div>
            <div class="emotion-section">
                <label>その時の感情</label>
                @for (int i = 0; i < defaultLength; i++)
                {
                    <div class="emotion-area">
                        <input id="emotion@(i + 1)" type="text" class="emotion">
                        <input id="emotion-point@(i + 1)" type="text" class="emotion-point">
                    </div>
                }
            </div>
            <div class="emotion-btn-area">
                @* TODO: emotion-areaの最下部と常に同じ行に表示させたい *@
                <button class="emotion-add-btn">感情の追加</button>
                <button class="emotion-del-btn">感情の削除</button>
            </div>
        </div>
        <div class="section-btn-area">
            <button class="section-add-btn">自動思考の追加</button>
            <button class="section-del-btn">自動思考の削除</button>
        </div>
    </div>

</div>
@* TODO: 下部に配置するボタンのレイアウト調整 *@ 
<div class="button-section">
    <a asp-page="Step01_Situation" class="btn-link">前の画面に戻る</a>
    <button>一時保存</button>

    <div class="right-group">
        <a asp-page="Step03_Evidence" class="btn-link">次へ</a>
    </div>
</div>

<script>

    // ロード時処理
    $(function(){

    });

    /* ボタン押下時の領域に対して感情エリアを追加／削除 */
    // 感情追加ボタン押下時
    $(document).on('click', '.emotion-add-btn', function(){
        const targetContainer = $(this).closest('.auto-thought-section');
        const emotionSection = targetContainer.find('.emotion-section');
        const originalArea = emotionSection.find('.emotion-area').first();
        
        // 初期化して複製
        const cloneArea = originalArea.clone();
        cloneArea.find('input').val('');
        cloneArea.id
        emotionSection.append(cloneArea);
    });

    // 感情削除ボタン押下時
    $(document).on('click', '.emotion-del-btn', function(){
        const targetContainer = $(this).closest('.auto-thought-section');
        const emotionSection = targetContainer.find('.emotion-section');
        const originalArea = emotionSection.find('.emotion-area');

        // 最低３件は残すよう削除
        if(originalArea.length <= 3) return;
        originalArea.last().remove();
    });

    // 自動思考セクション追加ボタン押下時
    $(document).on('click', '.section-add-btn', function(){
    
        // 追加先の領域を定義
        const addedSection = $(this).closest('.added-section');
        
        // 複製したいdiv要素を定義
        const template = addedSection.find('.auto-thought-section').first();
        const cloneSection = template.clone();

        // 入力初期化
        cloneSection.find('input[type="text"]').val('');
        cloneSection.find('input[type="radio"]').prop('checked', false);

        // 感情は3件にリセット
        const emotionSection = cloneSection.find('.emotion-section');
        emotionSection.find('.emotion-area').slice(3).remove();

        // セクションの追加／削除ボタンを配置
        addedSection.find('.section-btn-area').before(cloneSection);
    });

    // 自動思考セクション削除ボタン押下時
    $(document).on('click', '.section-del-btn', function(){

        // 最下部の自動思考セクションを定義
        const targetSection = $(this).closest('.added-section').find('.auto-thought-section');
        
        // 最低１件は残すよう削除
        if(targetSection.length <= 1) return;
        targetSection.last().remove();
    });
</script>